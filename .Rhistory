surv_cox <- cumprod(1-ifelse(sf$n.risk>0, sf$n.event/sf$n.risk, 0))
#dat[dat$ageout %in% surv_time[sf$n.risk==0],]
cilc_cox <- cumsum(ifelse(sflc$n.risk>0, sflc$n.event/sflc$n.risk, 0)*c(1, surv_cox[-length(surv_cox)]))
cinlc_cox <- cumsum(ifelse(sfnlc$n.risk>0, sfnlc$n.event/sfnlc$n.risk, 0)*c(1, surv_cox[-length(surv_cox)]))
hazlw_cox <- (ifelse(sfw$n.risk>0, sfw$n.event/sfw$n.risk, 0))
chazlw_cox <- cumsum(ifelse(sfw$n.risk>0, sfw$n.event/sfw$n.risk, 0))
plot(surv_time, cilc_cox, type='l')
plot(sf, mark.time=FALSE)
sum(sflc$n.event)
sum(dat$d)/length(unique(dat$id))
sf <- survfit(Surv(agein, ageout, d)~1, data=datf)
sflc <- survfit(Surv(agein, ageout, d_lc)~1, data=datf)
sfnlc <- survfit(Surv(agein, ageout, d_nonlc)~1, data=datf)
sfw <- survfit(Surv(agein, ageout, leftwork)~1, data=datf)
surv_timefull <- sf$time
surv_coxfull <- cumprod(1-ifelse(sf$n.risk>0, sf$n.event/sf$n.risk, 0))
#dat[dat$ageout %in% surv_time[sf$n.risk==0],]
cilc_coxfull <- cumsum(ifelse(sflc$n.risk>0, sflc$n.event/sflc$n.risk, 0)*c(1, surv_coxfull[-length(surv_coxfull)]))
cinlc_coxfull <- cumsum(ifelse(sfnlc$n.risk>0, sfnlc$n.event/sfnlc$n.risk, 0)*c(1, surv_coxfull[-length(surv_coxfull)]))
ggplot() + geom_step(aes(x, y, colour="Obs"), data=data.frame(x=surv_timefull[surv_timefull<90], y=cilc_coxfull[surv_timefull<90]))
ggplot() + geom_step(aes(x, y, colour="Obs"), data=data.frame(x=surv_time[surv_time<90], y=cilc_cox[surv_time<90]))
read_optim <- function(file){
r2 <- fread(file, data.table=FALSE, stringsAsFactors=FALSE,sep=",", header=TRUE, nrows=2, skip=26)
len <- length(names(r2)[grep("berkson", names(r2))])
if(len>0) {
dropped <- c(paste0("berkson.", 1:len), paste0("truewlm.", 1:len), paste0("truecumwlm2lag.", 1:len), paste0("truecumwlm2lagcen.", 1:len))
r2 <- r2[, -(which(names(r2) %in% dropped))]
}
r2 <- r2[, grep("cilc", names(r2))]
outdat <- data.frame(nc=t(r2[,grep( "_nc", names(r2))]), int24=t(r2[,grep( "_1", names(r2))]), int12=t(r2[,grep( "_2", names(r2))]), int4=t(r2[,grep( "_3", names(r2))]))
outdat$age <- 18:90
outdat
}
f1 <- "/Users/akeil/EpiProjects/CPUM/output/cpum_bayesgf_20151101_optim.csv"
f2 <- "/Users/akeil/EpiProjects/CPUM/output/cpum_bayesgf_20151029_optim.csv"
f3 <- "/Users/akeil/EpiProjects/CPUM/output/cpum_bayesgf_20151029_optim_full.csv"
f4 <- "/Users/akeil/EpiProjects/CPUM/output/cpum_bayesgf_20151101_optim_full.csv"
rdat1 <- read_optim(f1)
rdat2 <- read_optim(f2)
rdat3 <- read_optim(f3)
rdat4 <- read_optim(f4)
#comparing races
ggplot() + geom_line(aes(age, nc, colour="All races"), data=rdat3) +
geom_line(aes(age, nc, colour="Native Americans"), data=rdat2) + theme_bw() + scale_color_discrete(name="Nat Course")
ggplot() + geom_step(aes(x, y, colour="Obs"), data=data.frame(x=surv_timefull[surv_timefull<90], y=cilc_coxfull[surv_timefull<90])) +
geom_line(aes(age, nc, colour="Nat. course"), data=rdat3) +
geom_line(aes(age, int24, colour="<2WL"), data=rdat3) +
geom_line(aes(age, int4, colour="<0.33WL"), data=rdat3) + theme_bw() + scale_color_discrete(name="Intervention")
ggplot() + geom_line(aes(age, nc, colour="All races"), data=rdat3) +
geom_line(aes(age, nc, colour="Native Americans"), data=rdat2) + theme_bw() + scale_color_discrete(name="Nat Course")
ggplot() + geom_step(aes(x, y, colour="Obs"), data=data.frame(x=surv_timefull[surv_timefull<90], y=cilc_coxfull[surv_timefull<90])) +
geom_line(aes(age, nc, colour="Nat. course"), data=rdat3) +
geom_line(aes(age, int24, colour="<2WL"), data=rdat3) +
geom_line(aes(age, int4, colour="<0.33WL"), data=rdat3) + theme_bw() + scale_color_discrete(name="Intervention")
ggplot() + geom_step(aes(x, y, colour="Obs"), data=data.frame(x=surv_timefull[surv_timefull<90], y=cilc_coxfull[surv_timefull<90])) +
geom_line(aes(age, nc, colour="Nat. course"), data=rdat3) +
geom_line(aes(age, int24, colour="<2WL"), data=rdat3)
ggplot() + geom_step(aes(x, y, colour="Obs"), data=data.frame(x=surv_timefull[surv_timefull<90], y=cilc_coxfull[surv_timefull<90])) +
geom_line(aes(age, nc, colour="Nat. course"), data=rdat3) +
geom_line(aes(age, int24, colour="<2WL"), data=rdat3) +
geom_line(aes(age, int4, colour="<0.33WL"), data=rdat3) + theme_bw() + scale_color_discrete(name="Intervention")
ggplot() + geom_step(aes(x, y, colour="Obs"), data=data.frame(x=surv_time[surv_time<90], y=cilc_cox[surv_time<90])) +
geom_line(aes(age, nc, colour="Nat. course"), data=rdat2) +
geom_line(aes(age, int24, colour="<2WL"), data=rdat2) +
geom_line(aes(age, int4, colour="<0.33WL"), data=rdat2) + theme_bw() + scale_color_discrete(name="Intervention")
ggplot() + geom_step(aes(x, y, colour="Obs"), data=data.frame(x=surv_time[surv_time<90], y=cilc_cox[surv_time<90])) +
geom_line(aes(age, nc, colour="Nat. course, corrected"), data=rdat1) +
geom_line(aes(age, int24, colour="<2WL, corrected"), data=rdat1) +
#geom_line(aes(age, int24, colour="<2WL"), data=rdat2) +
geom_line(aes(age, int4, colour="<0.33WL, corrected"), data=rdat1) + theme_bw() + scale_color_discrete(name="Intervention")
ggplot() + geom_step(aes(x, y, colour="Obs"), data=data.frame(x=surv_time[surv_time<90], y=cilc_cox[surv_time<90])) +
geom_line(aes(age, int24, colour="<2WL", linetype="Corrected"), data=rdat1) +
geom_line(aes(age, int24, colour="<2WL", linetype="Uncorrected"), data=rdat2) +
geom_line(aes(age, int4, colour="<0.33WL", linetype="Uncorrected"), data=rdat2) +
geom_line(aes(age, int4, colour="<0.33WL", linetype="Corrected"), data=rdat1) +
theme_bw() + scale_color_discrete(name="Intervention")+ scale_linetype_discrete(name="")
ggplot() + geom_step(aes(x, y, colour="Obs"), data=data.frame(x=surv_time[surv_time<90], y=cilc_cox[surv_time<90])) +
geom_line(aes(age, nc, colour="Nat. course", linetype="Corrected"), data=rdat4) +
geom_line(aes(age, int24, colour="<2WL", linetype="Corrected"), data=rdat4) +
geom_line(aes(age, int4, colour="<0.33WL", linetype="Corrected"), data=rdat4) +
theme_bw() + scale_color_discrete(name="Intervention")+ scale_linetype_discrete(name="")
read_variational <- function(file){
f <- fread(file, data.table=FALSE, stringsAsFactors=FALSE,sep=",", header=TRUE)
len <- length(names(f)[grep("berkson", names(f))])
if(len>0) {
dropped <- c(paste0("berkson.", 1:len), paste0("truewlm.", 1:len), paste0("truecumwlm2lag.", 1:len), paste0("truecumwlm2lagcen.", 1:len))
f <- f[, -(which(names(f) %in% dropped))]
}
f <- f[, grep("cilc", names(f))]
rd <- f[, grep("cilc_nc", names(f))]-f[, grep("cilc_33", names(f))]
names(rd) <- paste0("rd", 1:73)
f <- cbind(f, rd)
med <- apply(f, 2, median)
lcl <- apply(f, 2, function(x) quantile(x, 0.025))
ucl <- apply(f, 2, function(x) quantile(x, 0.975))
outdat <- data.frame(
rd=(med[grep( "rd", names(med))]),
nc=(med[grep( "_nc", names(med))]),
int24=(med[grep( "_1", names(med))]),
int12=(med[grep( "_2", names(med))]),
int4=(med[grep( "_3", names(med))]),
rdcl=(lcl[grep( "rd", names(lcl))]),
ncl=(lcl[grep( "_nc", names(lcl))]),
int24l=(lcl[grep( "_1", names(lcl))]),
int12l=(lcl[grep( "_2", names(lcl))]),
int4l=(lcl[grep( "_3", names(lcl))]),
rdcu=(ucl[grep( "rd", names(ucl))]),
ncu=(ucl[grep( "_nc", names(ucl))]),
int24u=(ucl[grep( "_1", names(ucl))]),
int12u=(ucl[grep( "_2", names(ucl))]),
int4u=(ucl[grep( "_3", names(ucl))])
)
outdat$age <- 18:90
outdat
}
f1a <- "/Users/akeil/EpiProjects/CPUM/output/cpum_bayesgf_20151029_variational.csv"
f1b <- "/Users/akeil/EpiProjects/CPUM/output/cpum_bayesgf_20151101_variational.csv"
vdat <- read_variational(f1a)
vdat2 <- read_variational(f1b)
head(vdat)
#no measurement error correction
ggplot() + geom_step(aes(x, y, colour="Obs"), data=data.frame(x=surv_time[surv_time<90], y=cilc_cox[surv_time<90])) +
geom_line(aes(age, nc, colour="Nat. Course", linetype="Uncor"), data=vdat) +
geom_ribbon(aes(x=age, ymin=ncl, ymax=ncu, fill="Nat. Course"), data=vdat, alpha=0.5) +
geom_line(aes(age, int4, colour="<0.33 WLM", linetype="Uncor"), data=vdat) +
geom_ribbon(aes(x=age, ymin=int4l, ymax=int4u, fill="<0.33 WLM"), data=vdat, alpha=0.5)
ggplot() + geom_step(aes(x, y, colour="Obs"), data=data.frame(x=surv_time[surv_time<90], y=cilc_cox[surv_time<90])) +
geom_line(aes(age, nc, colour="Nat. Course", linetype="Cor"), data=vdat2) +
geom_ribbon(aes(x=age, ymin=ncl, ymax=ncu, fill="Nat. Course"), data=vdat2, alpha=0.5) +
geom_line(aes(age, int4, colour="<0.33 WLM", linetype="Cor"), data=vdat2) +
geom_ribbon(aes(x=age, ymin=int4l, ymax=int4u, fill="<0.33 WLM"), data=vdat2, alpha=0.5)
c(vdat$nc[73], vdat$ncl[73], vdat$ncu[73])
c(vdat$int4[73], vdat$int4[73], vdat$int4[73])
c(vdat$rd[73], vdat$rdcl[73], vdat$rdcu[73])
rdat2
rdat2$nc
rdat2$nc[73]
rdat3$nc[73]
ggplot() + geom_line(aes(age, nc, colour="All races"), data=rdat3) +
geom_line(aes(age, nc, colour="Native Americans"), data=rdat2) + theme_bw() + scale_color_discrete(name="Nat Course")
ggplot() + geom_step(aes(x, y, colour="Obs"), data=data.frame(x=surv_timefull[surv_timefull<90], y=cilc_coxfull[surv_timefull<90])) +
geom_line(aes(age, nc, colour="Nat. course"), data=rdat3) +
geom_line(aes(age, int24, colour="<2WL"), data=rdat3) +
geom_line(aes(age, int4, colour="<0.33WL"), data=rdat3) + theme_bw() + scale_color_discrete(name="Intervention")
plot(cilc_coxfull, surv_timefull)
plot(surv_timefull,cilc_coxfull)
plot(surv_timefull,cilc_coxfull, lty=1)
plot(surv_timefull,cilc_coxfull, type="l")
ggplot(data(y=surv_timefull,x=cilc_coxfull)) + geom_line(aes(x,y)) + theme_bw()
ggplot(data.frame(y=surv_timefull,x=cilc_coxfull)) + geom_line(aes(x,y)) + theme_bw()
ggplot(data.frame(x=surv_timefull,y=cilc_coxfull)) + geom_line(aes(x,y)) + theme_bw()
ggplot() + geom_line(aes(x,y), data=data.frame(x=surv_timefull,y=cilc_coxfull, color="Everyone")) +
geom_line(aes(x,y, color="Native Americans"), data=data.frame(x=surv_time,y=cilc_cox)) +
theme_bw()
ggplot() + geom_line(aes(x,y, color="Everyone"), data=data.frame(x=surv_timefull,y=cilc_coxfull)) +
geom_line(aes(x,y, color="Native Americans"), data=data.frame(x=surv_time,y=cilc_cox)) +
theme_bw()
ggplot() + geom_line(aes(x,y, color="Everyone"), data=data.frame(x=surv_timefull,y=cilc_coxfull)) +
geom_line(aes(x,y, color="Native Americans"), data=data.frame(x=surv_time,y=cilc_cox)) +
coord_cartesian(xlim=c(20, 90), ylim=c(0, .2) +
theme_bw()
)
ggplot() + geom_line(aes(x,y, color="Everyone"), data=data.frame(x=surv_timefull,y=cilc_coxfull)) +
geom_line(aes(x,y, color="Native Americans"), data=data.frame(x=surv_time,y=cilc_cox)) +
coord_cartesian(xlim=c(20, 90), ylim=c(0, .2)) +
theme_bw()
ggplot() + geom_line(aes(x,y, color="Everyone"), data=data.frame(x=surv_timefull,y=cilc_coxfull)) +
geom_line(aes(x,y, color="Native Americans"), data=data.frame(x=surv_time,y=cilc_cox)) +
coord_cartesian(xlim=c(20, 90), ylim=c(-0.01, .2)) +
theme_bw()
ggplot() + geom_line(aes(x,y, color="Everyone"), data=data.frame(x=surv_timefull,y=cilc_coxfull)) +
geom_line(aes(x,y, color="Native Americans"), data=data.frame(x=surv_time,y=cilc_cox)) +
coord_cartesian(xlim=c(19, 91), ylim=c(-0.01, .2)) +
theme_bw()
sf <- survfit(Surv(agein, ageout, d)~1, data=dat)
sf
sflc <- survfit(Surv(agein, ageout, d_lc)~1, data=dat)
sflc
sfnlc <- survfit(Surv(agein, ageout, d_nonlc)~1, data=dat)
sfnlc
sfw <- survfit(Surv(agein, ageout, leftwork)~1, data=dat)
surv_time <- sf$time
sf$time
cumprod(1-ifelse(sf$n.risk>0, sf$n.event/sf$n.risk, 0))
basehaz(sfw)
basehaz(coxph(Surv(agein, ageout, d)~1, data=dat))
plot(surv_time, cilc_cox, type='l')
#method 2
basehaz(coxph(Surv(agein, ageout, d)~1, data=dat))
basehaz(coxph(Surv(agein, ageout, d_lc)~1, data=dat))
sbh <- basehaz(coxph(Surv(agein, ageout, d)~1, data=dat))
names(sbh)
sbh$s <- exp(-cumsum(sbh$hazard))
sbh
sbh$s <- exp(-(sbh$hazard))
sbh
sbh$lch <- sbh_lc$hazard
sbh_lc <- basehaz(coxph(Surv(agein, ageout, d_lc)~1, data=dat))
sbh$lch <- sbh_lc$hazard
sbh$s <- exp(-(sbh$hazard))
sbh$s <- exp(-(sbh$hazard))
sbh
surv_cox
ggplot() + geom_line(aes(x,y, color="Everyone"), data=data.frame(x=surv_timefull,y=cilc_coxfull)) +
geom_line(aes(x,y, color="Native Americans"), data=data.frame(x=surv_time,y=cilc_cox)) +
coord_cartesian(xlim=c(19, 91), ylim=c(-0.01, .2)) +
theme_bw()
c(0, sbh_lc$hazard[-dim(sbh_lc)[1]])
diff(c(0, sbh_lc$hazard[-dim(sbh_lc)[1]]))
cumsum(diff(c(0, sbh_lc$hazard[-dim(sbh_lc)[1]]))*sbh$s)
length(sbh$s)
length(diff(c(0, sbh_lc$hazard[-dim(sbh_lc)[1]])))
sbh$lc_ci <- cumsum(diff(c(0, sbh_lc$hazard[]))*sbh$s)
cumsum(diff(c(0, sbh_lc$hazard[]))*sbh$s)
ggplot() + geom_line(aes(x,y, color="Everyone"), data=data.frame(x=surv_timefull,y=cilc_coxfull)) +
geom_line(aes(x,y, color="Native Americans, NA est"), data=data.frame(x=surv_time,y=cilc_cox)) +
geom_line(aes(x,y, color="Native Americans, AJ est"), data=data.frame(x=sbh$time,y=sbh$lc_ci)) +
coord_cartesian(xlim=c(19, 91), ylim=c(-0.01, .2)) +
theme_bw()
sbh_full <- basehaz(coxph(Surv(agein, ageout, d)~1, data=datf))
sbh_lc_full <- basehaz(coxph(Surv(agein, ageout, d_lc)~1, data=datf))
sbh_full$s <- exp(-(sbh_full$hazard))
sbh_full$lc_ci <- cumsum(diff(c(0, sbh_lc_full$hazard[]))*sbh_full$s)
ggplot() + geom_line(aes(x,y, color="Everyone, NA"), data=data.frame(x=surv_timefull,y=cilc_coxfull)) +
geom_line(aes(x,y, color="Everyone, AJ"), data=data.frame(x=sbh_full$time,y=sbh_full$lc_ci)) +
geom_line(aes(x,y, color="Native Americans, NA est"), data=data.frame(x=surv_time,y=cilc_cox)) +
geom_line(aes(x,y, color="Native Americans, AJ est"), data=data.frame(x=sbh$time,y=sbh$lc_ci)) +
coord_cartesian(xlim=c(19, 91), ylim=c(-0.01, .2)) +
theme_bw()
sbh_full <- basehaz(coxph(Surv(agein, ageout, d)~1, data=datf))
sbh_lc_full <- basehaz(coxph(Surv(agein, ageout, d_lc)~1, data=datf))
sbh_full$s <- exp(-(sbh_full$hazard))
sbh_full$lc_ci <- cumsum(diff(c(sbh_lc_full$hazard[], 0))*sbh_full$s)
ggplot() + geom_line(aes(x,y, color="Everyone, NA"), data=data.frame(x=surv_timefull,y=cilc_coxfull)) +
geom_line(aes(x,y, color="Everyone, AJ"), data=data.frame(x=sbh_full$time,y=sbh_full$lc_ci)) +
geom_line(aes(x,y, color="Native Americans, NA est"), data=data.frame(x=surv_time,y=cilc_cox)) +
geom_line(aes(x,y, color="Native Americans, AJ est"), data=data.frame(x=sbh$time,y=sbh$lc_ci)) +
coord_cartesian(xlim=c(19, 91), ylim=c(-0.01, .2)) +
theme_bw()
sbh_full$lc_ci <- cumsum(diff(c(0, sbh_lc_full$hazard[]))*sbh_full$s)
ggplot() + geom_line(aes(x,y, color="Everyone, NA"), data=data.frame(x=surv_timefull,y=cilc_coxfull)) +
geom_line(aes(x,y, color="Everyone, AJ"), data=data.frame(x=sbh_full$time,y=sbh_full$lc_ci)) +
geom_line(aes(x,y, color="Native Americans, NA est"), data=data.frame(x=surv_time,y=cilc_cox)) +
geom_line(aes(x,y, color="Native Americans, AJ est"), data=data.frame(x=sbh$time,y=sbh$lc_ci)) +
coord_cartesian(xlim=c(19, 91), ylim=c(-0.01, .2)) +
theme_bw()
ggplot() + geom_line(aes(x,y, color="Everyone, NA"), data=data.frame(x=surv_timefull,y=cilc_coxfull)) +
geom_line(aes(x,y, color="Everyone, AJ"), data=data.frame(x=sbh_full$time,y=sbh_full$lc_ci)) +
geom_line(aes(x,y, color="Native Americans, NA est"), data=data.frame(x=surv_time,y=cilc_cox)) +
geom_line(aes(x,y, color="Native Americans, AJ est"), data=data.frame(x=sbh$time,y=sbh$lc_ci)) +
coord_cartesian(xlim=c(19, 91), ylim=c(-0.01, .2)) + theme(legend_position=c(0,0)) +
theme_bw()
ggplot() + geom_line(aes(x,y, color="Everyone, NA"), data=data.frame(x=surv_timefull,y=cilc_coxfull)) +
geom_line(aes(x,y, color="Everyone, AJ"), data=data.frame(x=sbh_full$time,y=sbh_full$lc_ci)) +
geom_line(aes(x,y, color="Native Americans, NA est"), data=data.frame(x=surv_time,y=cilc_cox)) +
geom_line(aes(x,y, color="Native Americans, AJ est"), data=data.frame(x=sbh$time,y=sbh$lc_ci)) +
coord_cartesian(xlim=c(19, 91), ylim=c(-0.01, .2)) + theme(legend_pos=c(0,0)) +
theme_bw()
ggplot() + geom_line(aes(x,y, color="Everyone, NA"), data=data.frame(x=surv_timefull,y=cilc_coxfull)) +
geom_line(aes(x,y, color="Everyone, AJ"), data=data.frame(x=sbh_full$time,y=sbh_full$lc_ci)) +
geom_line(aes(x,y, color="Native Americans, NA est"), data=data.frame(x=surv_time,y=cilc_cox)) +
geom_line(aes(x,y, color="Native Americans, AJ est"), data=data.frame(x=sbh$time,y=sbh$lc_ci)) +
coord_cartesian(xlim=c(19, 91), ylim=c(-0.01, .2)) + theme(legend.position=c(0,0)) +
theme_bw()
ggplot() + geom_line(aes(x,y, color="Everyone, NA"), data=data.frame(x=surv_timefull,y=cilc_coxfull)) +
geom_line(aes(x,y, color="Everyone, AJ"), data=data.frame(x=sbh_full$time,y=sbh_full$lc_ci)) +
geom_line(aes(x,y, color="Native Americans, NA est"), data=data.frame(x=surv_time,y=cilc_cox)) +
geom_line(aes(x,y, color="Native Americans, AJ est"), data=data.frame(x=sbh$time,y=sbh$lc_ci)) +
coord_cartesian(xlim=c(19, 91), ylim=c(-0.01, .2)) + theme(legend.position=c(0,0)) +
theme_bw()
ggplot() + geom_line(aes(x,y, color="Everyone, NA"), data=data.frame(x=surv_timefull,y=cilc_coxfull)) +
geom_line(aes(x,y, color="Everyone, AJ"), data=data.frame(x=sbh_full$time,y=sbh_full$lc_ci)) +
geom_line(aes(x,y, color="Native Americans, NA est"), data=data.frame(x=surv_time,y=cilc_cox)) +
geom_line(aes(x,y, color="Native Americans, AJ est"), data=data.frame(x=sbh$time,y=sbh$lc_ci)) +
coord_cartesian(xlim=c(19, 91), ylim=c(-0.01, .2)) + theme(legend.position=c(1,0))
ggplot() + geom_line(aes(x,y, color="Everyone, NA"), data=data.frame(x=surv_timefull,y=cilc_coxfull)) +
geom_line(aes(x,y, color="Everyone, AJ"), data=data.frame(x=sbh_full$time,y=sbh_full$lc_ci)) +
geom_line(aes(x,y, color="Native Americans, NA est"), data=data.frame(x=surv_time,y=cilc_cox)) +
geom_line(aes(x,y, color="Native Americans, AJ est"), data=data.frame(x=sbh$time,y=sbh$lc_ci)) +
coord_cartesian(xlim=c(19, 91), ylim=c(-0.01, .2)) + theme(legend.position=c(1,0)) +
theme_bw()
ggplot() + geom_line(aes(x,y, color="Everyone, NA"), data=data.frame(x=surv_timefull,y=cilc_coxfull)) +
geom_line(aes(x,y, color="Everyone, AJ"), data=data.frame(x=sbh_full$time,y=sbh_full$lc_ci)) +
geom_line(aes(x,y, color="Native Americans, NA est"), data=data.frame(x=surv_time,y=cilc_cox)) +
geom_line(aes(x,y, color="Native Americans, AJ est"), data=data.frame(x=sbh$time,y=sbh$lc_ci)) +
coord_cartesian(xlim=c(19, 91), ylim=c(-0.01, .2)) + theme(legend.position=c(1,0), complete=FALSE) +
theme_bw()
sbh_full$lc_ci
sbh_full[sbh_full$time==90]$lc_ci
sbh_full[sbh_full$time<90]$lc_ci
sbh_full[sbh_full$time<90,]$lc_ci
sbh_full[sbh_full$time>89.9 & sbh_full$time<90.1,]$lc_ci
mean(sbh_full[sbh_full$time>89.9 & sbh_full$time<90.1,]$lc_ci)
sbh <- basehaz(coxph(Surv(agein, ageout, d)~1, data=dat))
sbh_lc <- basehaz(coxph(Surv(agein, ageout, d_lc)~1, data=dat, ties="breslow"))
sbh$s <- exp(-(sbh$hazard))
sbh$lc_ci <- cumsum(diff(c(0, sbh_lc$hazard[]))*sbh$s)
sum(sflc$n.event)
sum(dat$d)/length(unique(dat$id))
#fulldata
sf <- survfit(Surv(agein, ageout, d)~1, data=datf)
sflc <- survfit(Surv(agein, ageout, d_lc)~1, data=datf)
sfnlc <- survfit(Surv(agein, ageout, d_nonlc)~1, data=datf)
sfw <- survfit(Surv(agein, ageout, leftwork)~1, data=datf)
surv_timefull <- sf$time
surv_coxfull <- cumprod(1-ifelse(sf$n.risk>0, sf$n.event/sf$n.risk, 0))
#dat[dat$ageout %in% surv_time[sf$n.risk==0],]
cilc_coxfull <- cumsum(ifelse(sflc$n.risk>0, sflc$n.event/sflc$n.risk, 0)*c(1, surv_coxfull[-length(surv_coxfull)]))
cinlc_coxfull <- cumsum(ifelse(sfnlc$n.risk>0, sfnlc$n.event/sfnlc$n.risk, 0)*c(1, surv_coxfull[-length(surv_coxfull)]))
#method 2
sbh_full <- basehaz(coxph(Surv(agein, ageout, d)~1, data=datf))
sbh_lc_full <- basehaz(coxph(Surv(agein, ageout, d_lc)~1, data=datf, ties="breslow"))
sbh_full$s <- exp(-(sbh_full$hazard))
sbh_full$lc_ci <- cumsum(diff(c(0, sbh_lc_full$hazard))*sbh_full$s)
mean(sbh_full[sbh_full$time>89.9 & sbh_full$time<90.1,]$lc_ci)
ggplot() + geom_line(aes(x,y, color="Everyone, NA"), data=data.frame(x=surv_timefull,y=cilc_coxfull)) +
geom_line(aes(x,y, color="Everyone, AJ"), data=data.frame(x=sbh_full$time,y=sbh_full$lc_ci)) +
geom_line(aes(x,y, color="Native Americans, NA est"), data=data.frame(x=surv_time,y=cilc_cox)) +
geom_line(aes(x,y, color="Native Americans, AJ est"), data=data.frame(x=sbh$time,y=sbh$lc_ci)) +
coord_cartesian(xlim=c(19, 91), ylim=c(-0.01, .2)) +
theme_bw()
ggplot() + geom_step(aes(x, y, colour="Obs"), data=data.frame(x=surv_time[surv_time<90], y=cilc_cox[surv_time<90])) +
geom_line(aes(age, nc, colour="Nat. course"), data=rdat2) +
geom_line(aes(age, int24, colour="<2WL"), data=rdat2) +
geom_line(aes(age, int4, colour="<0.33WL"), data=rdat2) + theme_bw() + scale_color_discrete(name="Intervention")
ggplot() + geom_step(aes(x, y, colour="Obs"), data=data.frame(x=surv_time[surv_time<90], y=cilc_cox[surv_time<90])) +
geom_line(aes(age, nc, colour="Nat. course, corrected"), data=rdat1) +
geom_line(aes(age, int24, colour="<2WL, corrected"), data=rdat1) +
#geom_line(aes(age, int24, colour="<2WL"), data=rdat2) +
geom_line(aes(age, int4, colour="<0.33WL, corrected"), data=rdat1) + theme_bw() + scale_color_discrete(name="Intervention")
sbh <- basehaz(coxph(Surv(datein, dateout, d)~1, data=dat))
names(dat)
keep <- c("id", "dob", "datestart", "in", "out", "agestart", "agein", "ageout", "wlm", "wlm2lag","wlm5lag", "wlm10lag", "wlm20lag", "cumwlm", "cumwlm2lag", "cumwlm5lag", "cumwlm10lag",
"cumwlm20lag", "d", "d_lc", "d_nonlc", "tsfe", "cohort", "priorwlm", "race", "smoke3_1", "smoke3_2", "agestart", "py", "pyar",
"atwork", "atwork2lag", "atwork5lag", "leftwork")
names(an)
an$datein = an$in
an$datein = an$`in`
an$datein
an$dateout = an$dateout
keep <- c("id", "dob", "datestart", "datein", "dateout", "agestart", "agein", "ageout", "wlm", "wlm2lag","wlm5lag", "wlm10lag", "wlm20lag", "cumwlm", "cumwlm2lag", "cumwlm5lag", "cumwlm10lag",
"cumwlm20lag", "d", "d_lc", "d_nonlc", "tsfe", "cohort", "priorwlm", "race", "smoke3_1", "smoke3_2", "agestart", "py", "pyar",
"atwork", "atwork2lag", "atwork5lag", "leftwork")
#restrict to nonwhites
an$d_nonlc <- an$d-an$d_lc
an$ageout <- ifelse(an$agein==an$ageout, an$ageout+.01, an$ageout)
switch=0
dim(datf <- an[an$pyar>0 & !is.na(an$smoke3_2), keep])
dim(dat <- an[an$pyar>0 & an$race==2 & !is.na(an$smoke3_2), keep])
if(switch==0){ #quasi-failsafe
dat$oldatwork2lag = dat$atwork2lag
dat$oldcumwlm = dat$cumwlm
dat$oldcumwlm2lag = dat$cumwlm2lag
dat$oldcumwlm10lag = dat$cumwlm10lag
dat$oldcumatwork = dat$cumatwork
switch <- 1
}
dat$cumwlm = pmax(0, dat$oldcumwlm-dat$BL_cumwlm)
dat$cumwlm2lag = pmax(0, dat$oldcumwlm2lag-dat$BL_cumwlm)
dat$cumwlm10lag = pmax(0, dat$oldcumwlm10lag-dat$BL_cumwlm)
dat$cumatwork = pmax(0, dat$oldcumatwork-dat$BL_cumatwork)
dat$atwork2lag = ifelse(dat$agein>dat$agestart+1.99, 0, dat$oldatwork2lag)
dat$wlm_2_10 = pmax(0, dat$cumwlm2lag-dat$cumwlm10lag)
an <- read_sas("~/EpiProjects/CPUM/data/cpum_gf01.sas7bdat")
an$datein = an$`in`
an$dateout = an$out
#variables to keep
keep <- c("id", "dob", "datestart", "datein", "dateout", "agestart", "agein", "ageout", "wlm", "wlm2lag","wlm5lag", "wlm10lag", "wlm20lag", "cumwlm", "cumwlm2lag", "cumwlm5lag", "cumwlm10lag",
"cumwlm20lag", "d", "d_lc", "d_nonlc", "tsfe", "cohort", "priorwlm", "race", "smoke3_1", "smoke3_2", "agestart", "py", "pyar",
"atwork", "atwork2lag", "atwork5lag", "leftwork")
#restrict to nonwhites
an$d_nonlc <- an$d-an$d_lc
an$ageout <- ifelse(an$agein==an$ageout, an$ageout+.01, an$ageout)
switch=0
dim(datf <- an[an$pyar>0 & !is.na(an$smoke3_2), keep])
dim(dat <- an[an$pyar>0 & an$race==2 & !is.na(an$smoke3_2), keep])
if(switch==0){ #quasi-failsafe
dat$oldatwork2lag = dat$atwork2lag
dat$oldcumwlm = dat$cumwlm
dat$oldcumwlm2lag = dat$cumwlm2lag
dat$oldcumwlm10lag = dat$cumwlm10lag
dat$oldcumatwork = dat$cumatwork
switch <- 1
}
dat$cumwlm = pmax(0, dat$oldcumwlm-dat$BL_cumwlm)
dat$cumwlm2lag = pmax(0, dat$oldcumwlm2lag-dat$BL_cumwlm)
dat$cumwlm10lag = pmax(0, dat$oldcumwlm10lag-dat$BL_cumwlm)
dat$cumatwork = pmax(0, dat$oldcumatwork-dat$BL_cumatwork)
dat$atwork2lag = ifelse(dat$agein>dat$agestart+1.99, 0, dat$oldatwork2lag)
dat$wlm_2_10 = pmax(0, dat$cumwlm2lag-dat$cumwlm10lag)
#quick stats for comparison with natural course
mean(tapply(dat$cumwlm, dat$id, max)) # [1] 416.8733
mean(tapply(dat$atwork, dat$id, sum)) # [1] 6.197381
switch=0
dim(datf <- an[an$pyar>0 & !is.na(an$smoke3_2), keep])
dim(dat <- an[an$pyar>0 & an$race==2 & !is.na(an$smoke3_2), keep])
if(switch==0){ #quasi-failsafe
dat$oldatwork2lag = dat$atwork2lag
dat$oldcumwlm = dat$cumwlm
dat$oldcumwlm2lag = dat$cumwlm2lag
dat$oldcumwlm10lag = dat$cumwlm10lag
dat$oldcumatwork = dat$cumatwork
switch <- 1
}
dat$cumwlm = pmax(0, dat$oldcumwlm-dat$BL_cumwlm)
dat$oldcumwlm
dat$BL_cumwlm
keep <- c("id", "dob", "datestart", "datein", "dateout", "agestart", "agein", "ageout", "wlm", "wlm2lag","wlm5lag", "wlm10lag", "wlm20lag", "cumwlm", "cumwlm2lag", "cumwlm5lag", "cumwlm10lag",
"cumwlm20lag", "d", "d_lc", "d_nonlc", "tsfe", "cohort", "priorwlm", "race", "smoke3_1", "smoke3_2", "agestart", "py", "pyar",
"atwork", "atwork2lag", "atwork5lag", "leftwork", "BL_cumwlm", "BL_cumatwork")
#restrict to nonwhites
an$d_nonlc <- an$d-an$d_lc
an$ageout <- ifelse(an$agein==an$ageout, an$ageout+.01, an$ageout)
switch=0
dim(datf <- an[an$pyar>0 & !is.na(an$smoke3_2), keep])
dim(dat <- an[an$pyar>0 & an$race==2 & !is.na(an$smoke3_2), keep])
if(switch==0){ #quasi-failsafe
dat$oldatwork2lag = dat$atwork2lag
dat$oldcumwlm = dat$cumwlm
dat$oldcumwlm2lag = dat$cumwlm2lag
dat$oldcumwlm10lag = dat$cumwlm10lag
dat$oldcumatwork = dat$cumatwork
switch <- 1
}
dat$cumwlm = pmax(0, dat$oldcumwlm-dat$BL_cumwlm)
dat$cumwlm2lag = pmax(0, dat$oldcumwlm2lag-dat$BL_cumwlm)
dat$cumwlm10lag = pmax(0, dat$oldcumwlm10lag-dat$BL_cumwlm)
dat$cumatwork = pmax(0, dat$oldcumatwork-dat$BL_cumatwork)
dat$atwork2lag = ifelse(dat$agein>dat$agestart+1.99, 0, dat$oldatwork2lag)
dat$wlm_2_10 = pmax(0, dat$cumwlm2lag-dat$cumwlm10lag)
keep <- c("id", "dob", "datestart", "datein", "dateout", "agestart", "agein", "ageout", "wlm", "wlm2lag","wlm5lag", "wlm10lag", "wlm20lag", "cumwlm", "cumwlm2lag", "cumwlm5lag", "cumwlm10lag",
"cumwlm20lag", "d", "d_lc", "d_nonlc", "tsfe", "cohort", "priorwlm", "race", "smoke3_1", "smoke3_2", "agestart", "py", "pyar",
"atwork", "cumatwork", "atwork2lag", "atwork5lag", "leftwork", "BL_cumwlm", "BL_cumatwork")
#restrict to nonwhites
an$d_nonlc <- an$d-an$d_lc
an$ageout <- ifelse(an$agein==an$ageout, an$ageout+.01, an$ageout)
switch=0
dim(datf <- an[an$pyar>0 & !is.na(an$smoke3_2), keep])
dim(dat <- an[an$pyar>0 & an$race==2 & !is.na(an$smoke3_2), keep])
if(switch==0){ #quasi-failsafe
dat$oldatwork2lag = dat$atwork2lag
dat$oldcumwlm = dat$cumwlm
dat$oldcumwlm2lag = dat$cumwlm2lag
dat$oldcumwlm10lag = dat$cumwlm10lag
dat$oldcumatwork = dat$cumatwork
switch <- 1
}
dat$cumwlm = pmax(0, dat$oldcumwlm-dat$BL_cumwlm)
dat$cumwlm2lag = pmax(0, dat$oldcumwlm2lag-dat$BL_cumwlm)
dat$cumwlm10lag = pmax(0, dat$oldcumwlm10lag-dat$BL_cumwlm)
dat$cumatwork = pmax(0, dat$oldcumatwork-dat$BL_cumatwork)
dat$atwork2lag = ifelse(dat$agein>dat$agestart+1.99, 0, dat$oldatwork2lag)
dat$wlm_2_10 = pmax(0, dat$cumwlm2lag-dat$cumwlm10lag)
dat$cumatwork
sbh <- basehaz(coxph(Surv(datein, dateout, d)~1, data=dat))
sbh_lc <- basehaz(coxph(Surv(datein, dateout, d_lc)~1, data=dat, ties="breslow"))
datein
dat$datein
attributes(dat$datein)
install.packages('lubridate')
library(lubridate)
dat$yearin <- decimal_date(dat$datein)
dat$yearout <- decimal_date(dat$dateout)
()
sbh <- basehaz(coxph(Surv(yearin, yearout, d)~1, data=dat))
dat$yearin
dat$yearout
tail(sort(dat$yearin-dat$yearout))
dat$yearout <- ifelse(dat$yearin>= dat$yearout, dat$yearin+0.001, dat$yearout)
sbh <- basehaz(coxph(Surv(yearin, yearout, d)~1, data=dat))
sbh_lc <- basehaz(coxph(Surv(yearin, yearout, d_lc)~1, data=dat, ties="breslow"))
sbh$s <- exp(-(sbh$hazard))
sbh$lc_ci <- cumsum(diff(c(0, sbh_lc$hazard[]))*sbh$s)
ggplot() +
geom_line(aes(x,y), data=data.frame(x=sbd$time,y=sbd$lc_ci)) +
ggplot() +
geom_line(aes(x,y), data=data.frame(x=sbd$time,y=sbd$lc_ci))
sbd <- basehaz(coxph(Surv(yearin, yearout, d)~1, data=dat))
sbd_lc <- basehaz(coxph(Surv(yearin, yearout, d_lc)~1, data=dat, ties="breslow"))
sbd$s <- exp(-(sbd$hazard))
sbd$lc_ci <- cumsum(diff(c(0, sbd_lc$hazard[]))*sbh$s)
ggplot() +
geom_line(aes(x,y), data=data.frame(x=sbd$time,y=sbd$lc_ci))
datf$yearin <- decimal_date(datf$datein)
datf$yearout <- decimal_date(datf$dateout)
datf$yearout <- ifelse(datf$yearin>= datf$yearout, datf$yearin+0.001, datf$yearout)
sbd <- basehaz(coxph(Surv(yearin, yearout, d)~1, data=dat))
sbd_lc <- basehaz(coxph(Surv(yearin, yearout, d_lc)~1, data=dat, ties="breslow"))
sbd$s <- exp(-(sbd$hazard))
sbd$lc_ci <- cumsum(diff(c(0, sbd_lc$hazard[]))*sbd$s)
sbdf <- basehaz(coxph(Surv(yearin, yearout, d)~1, data=datf))
sbd_lcf <- basehaz(coxph(Surv(yearin, yearout, d_lc)~1, data=datf, ties="breslow"))
sbdf$s <- exp(-(sbdf$hazard))
sbdf$lc_ci <- cumsum(diff(c(0, sbd_lcf$hazard[]))*sbdf$s)
ggplot() +
geom_line(aes(x,y, linetype="NA"), data=data.frame(x=sbdf$time,y=sbdf$lc_ci)) +
geom_line(aes(x,y, linetype="Everyone"), data=data.frame(x=sbd$time,y=sbd$lc_ci))
sbdf <- basehaz(coxph(Surv(yearin, yearout, d)~1, data=datf))
sbd_lcf <- basehaz(coxph(Surv(yearin, yearout, d_lc)~1, data=datf, ties="breslow"))
sbdf$s <- exp(-(sbdf$hazard))
sbdf$lc_ci <- cumsum(diff(c(0, sbd_lcf$hazard[]))*sbdf$s)
ggplot() +
geom_line(aes(x,y, linetype="NA"), data=data.frame(x=sbdf$time,y=sbdf$lc_ci)) +
geom_line(aes(x,y, linetype="Everyone"), data=data.frame(x=sbd$time,y=sbd$lc_ci))
mean(sbh_full[sbh_full$time>89.9 & sbh_full$time<90.1,]$lc_ci)
max(sbdf[]$lc_ci)
basehaz(coxph(Surv(yearin, yearout, d)~1, data=datf))
basehaz(coxph(Surv(yearin, yearout, d_lc)~1, data=datf, ties="breslow"))
basehaz(coxph(Surv(yearin, yearout, d)~1, data=datf))
basehaz(coxph(Surv(yearin, yearout, d_lc)~1, data=datf, ties="breslow"))
exp(-(sbdf$hazard))
cumsum(diff(c(0, sbd_lcf$hazard[]))*sbdf$s)
